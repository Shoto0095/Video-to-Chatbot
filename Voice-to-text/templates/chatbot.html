<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
      }

      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .chat-container {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 1000;
      }

      .chat-window {
        width: 380px;
        border-radius: 16px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        overflow: hidden;
        margin-bottom: 16px;
      }

      .chat-messages {
        height: 400px;
        overflow-y: auto;
        padding: 16px;
        background: white;
      }

      .chat-messages::-webkit-scrollbar {
        width: 6px;
      }

      .chat-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      .chat-messages::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
      }

      .chat-messages::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      .message {
        margin-bottom: 16px;
        display: flex;
      }

      .message.user {
        justify-content: flex-end;
      }

      .message.bot {
        justify-content: flex-start;
      }

      .message-content {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 16px;
      }

      .message.user .message-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .message.bot .message-content {
        background: #f3f4f6;
        color: #1f2937;
      }

      .message-text {
        font-size: 14px;
        line-height: 1.5;
        white-space: pre-line;
      }

      .message-time {
        font-size: 11px;
        margin-top: 4px;
        opacity: 0.7;
      }

      .chat-input-container {
        padding: 16px;
        background: white;
        border-top: 1px solid #e5e7eb;
      }

      .chat-input-wrapper {
        display: flex;
        gap: 8px;
      }

      .chat-input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        outline: none;
      }

      .chat-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .send-button {
        padding: 10px 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 44px;
      }

      .send-button:hover {
        opacity: 0.9;
      }

      .toggle-button {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        cursor: pointer;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      .toggle-button:hover {
        transform: scale(1.05);
      }

      .toggle-button:active {
        transform: scale(0.95);
      }

      .pulse {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        animation: pulse 2s infinite;
        opacity: 0;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        100% {
          transform: scale(1.5);
          opacity: 0;
        }
      }

      .fade-in {
        animation: fadeIn 0.2s ease-in;
      }

      .fade-out {
        animation: fadeOut 0.2s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        to {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
        }
      }

      .hidden {
        display: none;
      }

      .chat-header {
        padding: 16px;
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .chat-header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .chat-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .close-button {
        background: transparent;
        border: none;
        color: white;
        cursor: pointer;
        padding: 4px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .close-button:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      @media (max-width: 480px) {
        .chat-window {
          width: calc(100vw - 32px);
        }
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <!-- Chat Window -->
      <div id="chatWindow" class="chat-window gradient-bg hidden">
        <!-- Header -->
        <div class="chat-header gradient-bg">
          <div class="chat-header-left">
            <div class="chat-avatar">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                ></path>
              </svg>
            </div>
            <div>
              <h3 style="font-weight: 600; font-size: 16px">Video Analyzer </h3>
              <p style="font-size: 12px; opacity: 0.9"> Solutions Expert</p>
            </div>
          </div>
          <button class="close-button" onclick="toggleChat()">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>

        <!-- Messages -->
        <div id="chatMessages" class="chat-messages"></div>

        <!-- Input -->
        <div class="chat-input-container">
          <div class="chat-input-wrapper">
            <input
              type="text"
              id="chatInput"
              class="chat-input"
              placeholder="Type your message..."
              onkeypress="handleKeyPress(event)"
            />
            <button class="send-button" onclick="sendMessage()">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Toggle Button -->
      <button id="toggleButton" class="toggle-button" onclick="toggleChat()">
        <span class="pulse"></span>
        <svg
          id="chatIcon"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
          ></path>
        </svg>
        <svg
          id="closeIcon"
          class="hidden"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <script>
      // Mock responses database
      const mockResponses = [
        {
          keywords: ["hello", "hi", "hey", "greetings"],
        },
        {
          keywords: ["service", "services", "what do you do", "offerings"],
          response:
            "Video Analyzer  offers comprehensive  solutions including:\nâ€¢ Recruitment & Staffing\nâ€¢ Payroll Management\nâ€¢  Compliance\nâ€¢ Employee Background Verification\nâ€¢ Contract Staffing\nâ€¢ Training & Development\n\nWhich service would you like to know more about?",
        },
        {
          keywords: ["recruitment", "hiring", "staffing", "job"],
          response:
            "Our recruitment services help you find the right talent for your organization. We specialize in permanent staffing, contract staffing, and executive search across various industries. Would you like to discuss your hiring needs?",
        },
        {
          keywords: ["payroll", "salary", "payment"],
          response:
            "We provide end-to-end payroll management services including salary processing, tax compliance, statutory deductions, and reporting. Our solutions ensure accurate and timely payroll processing for your organization.",
        },
        {
          keywords: ["compliance", "legal", "statutory"],
          response:
            "Our  compliance services ensure your organization adheres to all labor laws and statutory requirements. We help with PF, ESI, PT, gratuity, and other compliance matters to keep your business compliant and risk-free.",
        },
        {
          keywords: ["contact", "reach", "email", "phone", "call"],
          response:
            "You can reach us at:\nðŸ“§ Email: info@Video Analyzerhr.com\nðŸ“ž Phone: Contact through our website\nðŸŒ Website: Video Analyzerhr.com\n\nOur team is ready to assist you!",
        },
        {
          keywords: ["price", "cost", "pricing", "quote"],
          response:
            "Our pricing is customized based on your specific requirements and organization size. I'd be happy to connect you with our team for a detailed consultation and personalized quote. Would you like me to arrange a callback?",
        },
        {
          keywords: ["background", "verification", "check"],
          response:
            "We offer comprehensive employee background verification services including employment history, education verification, criminal record checks, and reference checks. This helps ensure you hire trustworthy candidates.",
        },
      ];

      let isOpen = false;
      let messages = [];
      let sessionId = null; // Track conversation session

      // Get or create session ID from sessionStorage (clears on page close/reload)
      function getOrCreateSessionId() {
        // IMPORTANT: Clear session_id on every page load/reload
        // This ensures fresh session on page reload
        sessionStorage.removeItem('Video Analyzer_session_id');
        sessionId = null;
        console.log('[SESSION] Session cleared on page load, backend will generate new one');
      }

      // Initialize chat with welcome message
      function initChat() {
        getOrCreateSessionId();
        addMessage(
          "Hello! Welcome to Video Analyzer . How can I assist you today?",
          "bot"
        );
      }

      // Toggle chat window
      function toggleChat() {
        isOpen = !isOpen;
        const chatWindow = document.getElementById("chatWindow");
        const chatIcon = document.getElementById("chatIcon");
        const closeIcon = document.getElementById("closeIcon");

        if (isOpen) {
          chatWindow.classList.remove("hidden");
          chatWindow.classList.add("fade-in");
          chatIcon.classList.add("hidden");
          closeIcon.classList.remove("hidden");
        } else {
          chatWindow.classList.add("fade-out");
          setTimeout(() => {
            chatWindow.classList.add("hidden");
            chatWindow.classList.remove("fade-out");
          }, 200);
          chatIcon.classList.remove("hidden");
          closeIcon.classList.add("hidden");
        }
      }

      // Add message to chat
      function addMessage(text, sender) {
        const messagesContainer = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}`;

        const time = new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });

        messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="message-text">${text}</div>
                        <div class="message-time">${time}</div>
                    </div>
                `;

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        messages.push({ text, sender, time });
      }

      // Get bot response
      async function getResponse(userMessage) {
        // Send session_id only if we have one (backend will generate if null)
        const headers = { 
          "Content-Type": "application/json"
        };
        
        if (sessionId) {
          headers["X-Session-ID"] = sessionId;
        }
        
        let res = await fetch("/chatting", {
          method: "POST",
          headers: headers,
          body: JSON.stringify({
            message: userMessage,
          }),
        });

        let data = await res.json();

        // Store session_id from response (backend generated or confirmed)
        if (data.session_id) {
          sessionId = data.session_id;
          sessionStorage.setItem('Video Analyzer_session_id', sessionId);
          console.log('[SESSION] Stored session_id:', sessionId.substring(0, 8) + '...');
        }

        // Return response even if status is not ok (401, 500, etc.)
        if (!res.ok) {
          return data.reply || `Error: ${res.status} ${res.statusText}`;
        }

        return data.reply;
      }

      function showTyping() {
        const container = document.getElementById("chatMessages");
        const typingDiv = document.createElement("div");
        typingDiv.className = "message bot";
        typingDiv.innerHTML = `
        <div class="message-content">
          <div class="message-text">Video Analyzer AI Typing...</div>
        </div>
      `;
        container.appendChild(typingDiv);
        container.scrollTop = container.scrollHeight;
        return typingDiv;
      }

      // Send message
      async function sendMessage() {
        const input = document.getElementById("chatInput");
        const message = input.value.trim();
        if (!message) return;

        addMessage(message, "user");
        input.value = "";

        const typingDiv = showTyping();

        try {
          const response = await getResponse(message);
          typingDiv.remove();
          addMessage(response, "bot");
        } catch (error) {
          typingDiv.remove();
          addMessage(`Error: ${error.message}`, "bot");
        }
      }

      // Handle Enter key
      function handleKeyPress(event) {
        if (event.key === "Enter") {
          sendMessage();
        }
      }

      // Initialize on page load
      window.addEventListener("load", initChat);
    </script>
  </body>
</html>
